# RTP通讯测试说明

## 测试拓扑
```
远端MCU (10.35.146.7:22) <---> TurboRelay <---> 近端终端 (10.35.146.109:10810)
                端口5533/5534                    端口5533/5534
```

## TurboRelay的RTP处理机制

### 1. 丢包检测机制
TurboRelay使用64位滑动窗口来检测丢包：

**什么情况认为是丢包？**
- 当收到序列号为N的包时，如果序列号N-1、N-2等还没收到，就认为是丢包
- 例如：收到序列号10、11、13，则认为序列号12丢包了
- 窗口大小为64，可以处理最多64个包的乱序

**丢包检测流程：**
1. 远端包到达 → 更新64位滑动窗口
2. 检查窗口中是否有缺失的序列号
3. 如果有缺失 → 触发NACK机制
4. 包被缓存，等待缺失包到达后再按序转发

### 2. NACK触发机制
**何时触发NACK？**
- 检测到丢包时立即触发
- 每个缺失的序列号都会启动独立的NACK重试流程

**独立NACK跟踪机制：**
- 每个缺失的序列号都有独立的NACK跟踪信息（NACKInfo）
- 包含：首次NACK时间、最后NACK时间、重试次数、放弃时间
- **解决窗口滑动问题**：即使序列号超出64位窗口范围，NACK跟踪仍然继续
- 只有在以下情况下才停止NACK：
  1. 对应的包真正收到了
  2. 达到最大重试次数（5次）
  3. 超过总超时时间（500ms）

**NACK重试策略：**
- 最大重试5次（增加了重试次数）
- 总超时时间：500ms（避免无限等待）
- 重试间隔：初始为NACKTimeout（默认100ms），每次重试增加1.5倍（指数退避）
- 第1次：100ms后发送NACK
- 第2次：150ms后发送NACK  
- 第3次：225ms后发送NACK
- 第4次：337ms后发送NACK
- 第5次：505ms后发送NACK（可能超时）

**NACK停止条件：**
- ✅ 缺失的包收到了 → 立即停止NACK
- ✅ 达到最大重试次数（5次）→ 放弃该包
- ✅ 超过总超时时间（500ms）→ 放弃该包
- ❌ ~~序列号超出窗口范围~~ → **不再作为停止条件**

### 3. 包转发机制
**近端包（终端→MCU）：**
- 直接转发，同时缓存1000个包用于NACK重传

**远端包（MCU→终端）：**
- 使用64位窗口检测丢包和乱序
- 缓存包，等待缺失包到达
- 按序转发连续的包序列
- 对于太旧的包直接丢弃

### 4. 窗口处理复杂场景
**回绕处理：**
- 支持序列号从65535回绕到0
- 例如：65534, 65535, 0, 1, 2 被正确识别为连续序列

**乱序处理：**
- 64位窗口可以处理复杂乱序：65534, 65533, 1, 2, 3, 4, 65535
- 窗口会自动调整基准位置来容纳乱序包

**大跳跃处理：**
- 如果序列号跳跃超过窗口大小的2倍，重置窗口
- 避免因为网络问题导致的大范围序列号跳跃

## 程序功能

### 远端测试程序 (test_far_end.py)
运行在10.35.146.7，模拟MCU设备：
- **发送流**：每50ms发送RTP包，序列号60000-65000（测试回绕）
- **模拟问题**：5%丢包 + 10%乱序，测试TurboRelay的处理能力
- **NACK响应**：收到NACK请求时重传对应的包
- **接收流**：接收来自近端的RTP包并打印统计

### 近端测试程序 (test_near_end.py)  
运行在10.35.146.109，模拟终端设备：
- **发送流**：每50ms正常发送RTP包，序列号1000-2000
- **严格检查**：要求接收的包必须连续、不乱序、不丢包
- **错误检测**：任何乱序或丢包都会停止程序并报告问题

## 测试步骤

### 1. 启动TurboRelay
```bash
# 在加速器上运行
sudo ./turbo_relay -if1 eth0 -if2 eth1 -debug
```

### 2. 启动远端程序
```bash
# 在10.35.146.7上运行
python3 test_far_end.py
```

### 3. 启动近端程序  
```bash
# 在10.35.146.109上运行
python3 test_near_end.py
```

## 预期结果

### 成功场景
- 近端程序收到连续的RTP包，序列号无跳跃
- 远端程序收到NACK请求并成功重传
- TurboRelay日志显示NACK发送和包重排序
- 双向RTP通信正常

### 问题诊断
**如果近端检测到乱序/丢包：**
- 检查TurboRelay的NACK机制是否工作
- 查看远端是否正确响应NACK请求
- 确认网络延迟是否超过NACK超时时间

**如果NACK不工作：**
- 检查RTCP端口配置（5534）
- 确认TurboRelay能正确构建和发送NACK包
- 查看远端程序是否正确解析NACK包

## 调试命令

### 抓包分析
```bash
# 抓取RTP流量
sudo tcpdump -i any -w rtp_test.pcap udp port 5533

# 抓取RTCP流量（包含NACK）
sudo tcpdump -i any -w rtcp_test.pcap udp port 5534

# 实时查看包内容
sudo tcpdump -i any -X udp port 5533 or udp port 5534
```

### 网络状态检查
```bash
# 检查路由
ip route show

# 检查网络接口
ip addr show

# 测试连通性
ping 10.35.146.7
ping 10.35.146.109
```

## 故障排除

### 常见问题
1. **端口被占用**：使用`netstat -tulpn | grep 5533`检查
2. **防火墙阻拦**：临时关闭防火墙测试
3. **权限不足**：确保以root权限运行TurboRelay
4. **网络配置**：确认IP地址和路由正确

### 日志分析
- TurboRelay日志：查看RTP处理和NACK发送
- 测试程序日志：查看包发送/接收统计
- 系统日志：查看网络相关错误