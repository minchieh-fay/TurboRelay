# TurboRelay RTP测试工具集

## 概述

本目录包含了用于测试TurboRelay RTP序列号窗口功能的完整测试工具集。新的序列号窗口逻辑使用32位滑动窗口来处理乱序、丢包和重复包，相比之前的单一`expectedSeq`方法更加健壮。

## 测试环境

- **近端设备**: 10.35.146.9:10810 (终端)
- **远端设备**: 10.35.146.7:22 (MCU)
- **测试端口**: 5004 (RTP)

## 测试工具

### 1. 快速启动脚本 (推荐)

```bash
./start_rtp_test.sh
```

提供交互式菜单，包含：
- 远端包测试 (测试序列号窗口逻辑)
- 近端包测试 (测试直接转发)
- 双向测试 (测试SSRC冲突处理)
- 特定场景测试
- 查看测试指南

### 2. Python RTP发送器

```bash
# 基本用法
python3 rtp_test_sender.py <目标IP> <目标端口> [选项]

# 示例
python3 rtp_test_sender.py 10.35.146.9 5004 --source "远端MCU" --test all
python3 rtp_test_sender.py 10.35.146.7 5004 --source "近端终端" --test normal
```

**支持的测试类型:**
- `all`: 所有测试
- `normal`: 正常序列 (1,2,3,4,5)
- `ooo`: 乱序 (10,12,11,13,15,14)
- `loss`: 丢包 (20,21,22,25,26 + 补发23,24)
- `wrap`: 回绕 (65533,65534,65535,0,1,2)
- `dup`: 重复包 (30,31,31,32,32,33)
- `jump`: 大跳跃 (40,41,42,1000,1001)

### 3. Bash测试脚本

```bash
# 本地测试
./test_rtp_window.sh

# 远程测试 (通过SSH)
./test_rtp_remote.sh
```

## 核心改进

### 序列号窗口逻辑

**之前的问题:**
- 使用单一`expectedSeq`，无法很好处理乱序
- 简单的序列号比较，回绕处理不完善
- 缓存逻辑复杂，容易出错

**新的解决方案:**
- 32位滑动窗口，使用位掩码跟踪接收状态
- 完善的序列号回绕处理 (`calculateSeqDiff`)
- 窗口自动滑动和扩展机制
- 清晰的转发判断逻辑

### 关键函数

1. **`updateSequenceWindow`**: 核心窗口更新逻辑
2. **`calculateSeqDiff`**: 序列号差值计算 (处理回绕)
3. **`canForwardFromWindow`**: 判断是否可以转发
4. **`getMissingSequences`**: 获取缺失的序列号

## 测试场景详解

### 1. 正常序列测试
验证基本的序列号处理能力。

### 2. 乱序测试
测试窗口的缓存和重排能力：
- 收到未来包时缓存
- 收到填补包时触发连续转发

### 3. 丢包测试
验证NACK机制：
- 检测缺失序列号
- 超时后发送NACK
- 处理补发包

### 4. 序列号回绕测试
验证16位序列号从65535到0的回绕处理。

### 5. 重复包测试
验证重复包检测和丢弃机制。

### 6. 大跳跃测试
验证窗口重置机制，处理序列号大幅跳跃。

## 验证要点

### 日志检查
观察调试日志中的窗口状态：
```
Far-end RTP: SSRC=305419896, Seq=12, Forward=false, New=true, Window=[Base:10 Max:12 Mask:0x00000005 Missing:[11]]
```

### 统计信息
- 接收/转发/缓存/丢弃包数
- NACK发送/接收数
- 乱序包数

### 窗口状态
- Base: 窗口基准序列号
- Max: 最大序列号
- Mask: 接收位掩码
- Missing: 缺失序列号列表

## 使用流程

1. **启动turbo_relay**
```bash
./turbo_relay if1 if2 --enable-rtp --debug
```

2. **运行测试**
```bash
./start_rtp_test.sh
```

3. **观察日志**
检查turbo_relay的输出，验证序列号窗口逻辑。

4. **分析结果**
根据测试指南验证各项功能是否正常。

## 文件说明

- `start_rtp_test.sh`: 交互式测试启动脚本
- `rtp_test_sender.py`: Python RTP包发送器
- `test_rtp_window.sh`: 本地Bash测试脚本
- `test_rtp_remote.sh`: 远程Bash测试脚本
- `RTP_TESTING_GUIDE.md`: 详细测试指南
- `README_TESTING.md`: 本文档

## 注意事项

1. **网络环境**: 确保测试机器之间网络连通
2. **权限**: 可能需要root权限发送UDP包
3. **端口**: 确保测试端口未被占用
4. **调试模式**: 启用turbo_relay的调试模式以查看详细日志
5. **时间间隔**: 根据网络延迟调整测试包间隔

## 故障排除

### 包未被识别为RTP
- 检查包格式和长度
- 验证RTP版本和payload type

### 序列号处理异常
- 检查回绕处理逻辑
- 验证窗口操作

### NACK未触发
- 检查超时设置
- 验证缺失检测逻辑

通过这套完整的测试工具，可以全面验证RTP序列号窗口逻辑的正确性和性能。 